---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Kinetix Engine Demo" showFooter={false} showAds={false}>
    <main class="min-h-screen bg-[#1a1a1a] text-white p-8 font-sans">
        <div class="max-w-[1800px] mx-auto">
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1
                        class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400"
                    >
                        Kinetix Core
                    </h1>
                    <p class="text-gray-400 mt-2">
                        Open Source Engine Verification & Demo
                    </p>
                </div>
                <div class="flex gap-4">
                    <a
                        href="/create"
                        class="px-4 py-2 rounded bg-gray-800 hover:bg-gray-700 transition text-sm"
                    >
                        Back to Editor
                    </a>
                    <a
                        href="https://github.com/simplearyan/kinetix"
                        target="_blank"
                        class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 transition text-sm font-semibold"
                    >
                        GitHub
                    </a>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Controls Sidebar -->
                <div class="space-y-6">
                    <!-- Canvas Settings -->
                    <!-- Canvas Settings -->
                    <div
                        id="settings-container"
                        class="bg-[#2a2a2a] p-6 rounded-xl border border-white/5"
                    >
                        <!-- Resolution Picker Mount -->
                    </div>

                    <!-- Object controls -->
                    <div
                        class="bg-[#2a2a2a] p-6 rounded-xl border border-white/5"
                    >
                        <h2
                            class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4"
                        >
                            Scene
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button
                                id="btn-add-rect"
                                class="bg-gray-700 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition text-left flex items-center gap-2"
                            >
                                <span class="w-2 h-2 rounded-full bg-blue-400"
                                ></span> Add Rect
                            </button>
                            <button
                                id="btn-add-text"
                                class="bg-gray-700 hover:bg-purple-600 text-white px-3 py-2 rounded text-sm transition text-left flex items-center gap-2"
                            >
                                <span class="w-2 h-2 rounded-full bg-purple-400"
                                ></span> Add Text
                            </button>
                        </div>
                        <div
                            id="object-list"
                            class="mt-4 space-y-2 max-h-40 overflow-y-auto custom-scrollbar"
                        >
                            <!-- Items added here -->
                        </div>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="lg:col-span-2">
                    <div
                        id="canvas-container"
                        class="relative aspect-video bg-black rounded-xl overflow-hidden shadow-2xl border border-white/10 ring-4 ring-black/20 flex justify-center items-center transition-colors"
                    >
                        <canvas id="engine-canvas" class="w-full h-full block"
                        ></canvas>

                        <!-- Loading Overlay -->
                        <div
                            id="loader"
                            class="absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-10 hidden"
                        >
                            <div
                                class="w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"
                            >
                            </div>
                        </div>

                        <!-- Drag Overlay -->
                        <div
                            id="drag-overlay"
                            class="absolute inset-0 flex items-center justify-center bg-blue-500/20 backdrop-blur-sm z-30 hidden pointer-events-none border-4 border-blue-500 border-dashed m-4 rounded-xl"
                        >
                            <div class="text-blue-200 font-bold text-xl">
                                Drop Video Here
                            </div>
                        </div>
                    </div>

                    <!-- Code Preview -->
                    <div
                        class="mt-8 bg-[#151515] rounded-xl p-6 border border-white/5 font-mono text-sm"
                    >
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-500">Live Code Check</span>
                            <span
                                class="text-xs text-emerald-400 bg-emerald-400/10 px-2 py-1 rounded"
                                >@kinetix/core</span
                            >
                        </div>
                        <pre
                            class="text-gray-300 overflow-x-auto"><code id="code-preview">// Engine initializing...</code></pre>
                    </div>
                </div>

                <!-- Right Sidebar (Export) -->
                <div class="space-y-6">
                    <!-- Export controls -->
                    <div
                        id="export-container"
                        class="bg-[#2a2a2a] p-6 rounded-xl border border-white/5"
                    >
                        <!-- Export Controls Mount -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        import {
            Engine,
            PlayerOverlay,
            VideoObject,
            CanvasControl,
            ExportControl,
        } from "../open-source-engine/src/index.ts";
        import { KinetixObject } from "../open-source-engine/src/objects/Object.ts";

        // --- Custom Implementation for Demo ---
        class RectObject extends KinetixObject {
            color: string;
            constructor(id: string, color: string) {
                super(id, "Rect");
                this.color = color;
                this.width = 200;
                this.height = 200;
            }
            draw(ctx: CanvasRenderingContext2D, time: number) {
                ctx.fillStyle = this.color;
                const cx = this.x + this.width / 2;
                const cy = this.y + this.height / 2;

                ctx.translate(cx, cy);
                ctx.rotate((this.rotation * Math.PI) / 180);
                ctx.translate(-cx, -cy);

                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            clone() {
                return new RectObject("clone_" + this.id, this.color);
            }
        }

        class DemoTextObject extends KinetixObject {
            text: string;
            constructor(id: string, text: string) {
                super(id, "Text");
                this.text = text;
                this.width = 300;
                this.height = 60;
            }
            draw(ctx: CanvasRenderingContext2D, time: number) {
                ctx.font = "bold 40px 'Inter', sans-serif";
                ctx.fillStyle = "white";
                ctx.fillText(this.text, this.x, this.y + 40);
            }
            clone() {
                return new DemoTextObject("clone_" + this.id, this.text);
            }
        }

        // --- Initialization ---
        const canvas = document.getElementById(
            "engine-canvas",
        ) as HTMLCanvasElement;
        const canvasContainer =
            document.querySelector("#engine-canvas")?.parentElement;

        // Initialize Engine
        const engine = new Engine(canvas);

        const codePreview = document.getElementById("code-preview");

        // Helper: Format MM:SS
        const formatTime = (ms: number) => {
            const totalSeconds = Math.floor(ms / 1000);
            const m = Math.floor(totalSeconds / 60)
                .toString()
                .padStart(2, "0");
            const s = (totalSeconds % 60).toString().padStart(2, "0");
            // Optional: show millis? .toString().padStart(3, '0')
            // For general video player, mm:ss is standard.
            // If we want precision:
            // const millis = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
            return `${m}:${s}`;
        };

        // UI Components
        new PlayerOverlay(engine, document.getElementById("canvas-container")); // Mount directly to relative container
        new CanvasControl(
            engine,
            document.getElementById("settings-container"),
        );
        new ExportControl(engine, document.getElementById("export-container"));

        // REMOVED: Auto-resize listener
        // window.addEventListener("resize", resize);

        document
            .getElementById("btn-add-rect")
            ?.addEventListener("click", () => {
                console.log("Adding Rect...");
                try {
                    const id = "rect_" + Date.now();
                    const rect = new RectObject(id, "#3b82f6");
                    // Center it roughly
                    rect.x = engine.scene.width / 2 - 100;
                    rect.y = engine.scene.height / 2 - 100;
                    rect.rotation = 0;

                    engine.scene.add(rect);
                    updateCodePreview();
                    addToList(id, "Rectangle");
                } catch (e) {
                    console.error(e);
                    alert("Error adding rect: " + e);
                }
            });

        document
            .getElementById("btn-add-text")
            ?.addEventListener("click", () => {
                console.log("Adding Text...");
                try {
                    const id = "text_" + Date.now();
                    const text = new DemoTextObject(id, "Hello World");
                    text.x = engine.scene.width / 2 - 150;
                    text.y = engine.scene.height / 2;
                    engine.scene.add(text);
                    updateCodePreview();
                    addToList(id, "Text");
                } catch (e) {
                    console.error(e);
                    alert("Error adding text: " + e);
                }
            });

        function updateCodePreview() {
            if (!codePreview) return;
            const lines = [
                `const engine = new Engine(canvas);`,
                `engine.resize(${engine.scene.width}, ${engine.scene.height});`,
            ];
            engine.scene.objects.forEach((obj) => {
                lines.push(
                    `engine.scene.add(new ${obj.name}("${obj.id}")); // x:${obj.x.toFixed(0)}, y:${obj.y.toFixed(0)}`,
                );
            });
            codePreview.innerText = lines.join("\n");
        }

        function addToList(id: string, label: string) {
            const list = document.getElementById("object-list");
            if (!list) return;
            const el = document.createElement("div");
            el.className =
                "flex justify-between items-center bg-black/20 p-2 rounded text-xs text-gray-300";
            el.innerHTML = `<span>${label}</span> <span class="text-gray-600 font-mono">${id.slice(-4)}</span>`;
            list.appendChild(el);
        }

        // Start
        updateCodePreview();

        // --- Drag & Drop ---
        const dragOverlay = document.getElementById("drag-overlay");

        if (canvasContainer) {
            canvasContainer.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dragOverlay?.classList.remove("hidden");
            });

            canvasContainer.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            canvasContainer.addEventListener("dragleave", (e) => {
                e.preventDefault();
                // Simple check to ensure we left the container
                if (
                    e.relatedTarget &&
                    canvasContainer.contains(e.relatedTarget as Node)
                )
                    return;
                dragOverlay?.classList.add("hidden");
            });

            canvasContainer.addEventListener("drop", (e) => {
                e.preventDefault();
                dragOverlay?.classList.add("hidden");

                const files = e.dataTransfer?.files;
                if (!files || files.length === 0) return;

                const file = files[0];
                if (file.type.startsWith("video/")) {
                    const url = URL.createObjectURL(file);
                    const id = "vid_" + Date.now();
                    const videoObj = new VideoObject(id, url);

                    // Center
                    videoObj.x = 0;
                    videoObj.y = 0;
                    videoObj.width = engine.scene.width;
                    videoObj.height = engine.scene.height;

                    engine.scene.add(videoObj);
                    updateCodePreview();
                    addToList(id, "Video");
                } else {
                    alert("Please drop a video file.");
                }
            });
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        /* Ensure canvas fits visually but maintains aspect ratio */
        #engine-canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            width: auto;
            height: auto;
        }
    </style>
</Layout>
