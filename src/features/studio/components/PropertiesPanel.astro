---

---

<div class="flex-1 overflow-y-auto p-4 space-y-4" id="properties-panel">
    <div
        class="text-gray-500 text-center text-sm pt-10 flex flex-col items-center gap-4"
    >
        <span>Select an object to edit</span>
        <div
            class="w-8 h-8 rounded-full border-2 border-dashed border-gray-700"
        >
        </div>
    </div>
</div>

<script>
    import { selectedObjectId } from "../../stores/studioStore";

    const panel = document.getElementById("properties-panel")!;

    selectedObjectId.subscribe((id) => {
        // Dispatch an event to request property data from the engine
        // The view shouldn't know about the engine directly if possible, or we can cheat and use window.engine

        if (!id) {
            panel.innerHTML = `<div class="text-gray-500 text-center text-sm pt-10 flex flex-col items-center gap-4">
                <span>Select an object to edit</span>
                <div class="w-8 h-8 rounded-full border-2 border-dashed border-gray-700"></div>
            </div>`;
            return;
        }

        // Request render
        // We'll use a custom event pattern again: The main page logic that holds the engine
        // will listen for 'studio:request-props' or we just assume window.studioEngine is available
        // for simplicity in this specific "App Page" context.

        if ((window as any).studioEngine) {
            renderProps((window as any).studioEngine.getObject(id));
        }
    });

    function renderProps(obj: any) {
        if (!obj) return;

        const props = obj.getProperties();
        let html = `<div class="animate-fade-in space-y-6">
            <div class="flex items-center justify-between border-b border-gray-200 dark:border-gray-800 pb-2">
                 <h3 class="font-bold text-[11px] uppercase tracking-wider text-gray-500 dark:text-gray-400">
                    ${obj.type}
                </h3>
                <span class="text-[10px] text-gray-400 font-mono opacity-50">#${obj.id.split("-")[1] || obj.id}</span>
            </div>`;

        for (const [key, val] of Object.entries(props)) {
            // Beautify keys
            const label = key.replace(/([A-Z])/g, " $1").trim();
            const isNum = typeof val === "number";
            const isColor =
                typeof val === "string" &&
                (key.toLowerCase().includes("color") ||
                    key.includes("fill") ||
                    key.includes("stroke"));

            // Helper to sanitize color for input type="color" (must be #RRGGBB)
            const toHex = (c: any) => {
                if (!c || typeof c !== "string") return "#000000";
                if (c.startsWith("#") && c.length === 7) return c;
                if (c === "transparent") return "#000000"; // Fallback

                // Simple canvas hack to get hex from any string
                const ctx = document.createElement("canvas").getContext("2d");
                if (!ctx) return "#000000";
                ctx.fillStyle = c;
                return ctx.fillStyle; // returns #RRGGBB usually
            };
            const hexVal = isColor ? toHex(val) : val;

            html += `
                <div class="flex flex-col gap-1.5">
                    <label class="text-[10px] uppercase font-bold text-gray-400 tracking-wider truncate" title="${label}">${label}</label>
                    <div class="flex items-center gap-2 group/input">
                        ${
                            isColor
                                ? `
                            <div class="w-8 h-8 rounded-lg shadow-sm ring-1 ring-gray-200 dark:ring-gray-700 overflow-hidden shrink-0 cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all relative">
                                <input type="color" 
                                    data-key="${key}"
                                    value="${hexVal}" 
                                    class="prop-color absolute w-[150%] h-[150%] -top-1/4 -left-1/4 cursor-pointer p-0 border-0"
                                >
                            </div>
                            <div class="flex-1">
                                <span class="text-xs font-mono text-gray-500 dark:text-gray-400 uppercase">${val}</span>
                            </div>
                        `
                                : key === "theme"
                                  ? `
                            <select data-key="${key}" class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all font-medium cursor-pointer appearance-none">
                                <option value="dark" ${val === "dark" ? "selected" : ""}>Dark</option>
                                <option value="light" ${val === "light" ? "selected" : ""}>Light</option>
                                <option value="vscode" ${val === "vscode" ? "selected" : ""}>VS Code</option>
                                <option value="classic" ${val === "classic" ? "selected" : ""}>Classic</option>
                                <option value="matrix" ${val === "matrix" ? "selected" : ""}>Matrix</option>
                                <option value="dracula" ${val === "dracula" ? "selected" : ""}>Dracula</option>
                            </select>
                            `
                                  : key === "animationType"
                                    ? `
                            <select data-key="${key}" class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all font-medium cursor-pointer appearance-none">
                                <option value="none" ${val === "none" ? "selected" : ""}>None</option>
                                <option value="typewriter" ${val === "typewriter" ? "selected" : ""}>Typewriter</option>
                                <option value="line-by-line" ${val === "line-by-line" ? "selected" : ""}>Line by Line</option>
                                <option value="fade" ${val === "fade" ? "selected" : ""}>Fade</option>
                                <option value="slide-up" ${val === "slide-up" ? "selected" : ""}>Slide Up</option>
                                <option value="scale-up" ${val === "scale-up" ? "selected" : ""}>Scale Up</option>
                                <option value="rotate-in" ${val === "rotate-in" ? "selected" : ""}>Rotate In</option>
                            </select>
                            `
                                    : key === "chartType"
                                      ? `
                            <select data-key="${key}" class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all font-medium cursor-pointer appearance-none">
                                <option value="bar" ${val === "bar" ? "selected" : ""}>Bar Chart</option>
                                <option value="line" ${val === "line" ? "selected" : ""}>Line Chart</option>
                                <option value="area" ${val === "area" ? "selected" : ""}>Area Chart</option>
                                <option value="pie" ${val === "pie" ? "selected" : ""}>Pie Chart</option>
                            </select>
                            `
                                      : key === "styleVariant"
                                        ? `
                            <select data-key="${key}" class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all font-medium cursor-pointer appearance-none">
                                <option value="clean" ${val === "clean" ? "selected" : ""}>Clean</option>
                                <option value="scribble" ${val === "scribble" ? "selected" : ""}>Scribble</option>
                                <option value="vox" ${val === "vox" ? "selected" : ""}>Vox Style</option>
                            </select>
                            `
                                        : key === "data"
                                          ? `
                            <div class="flex flex-col gap-2">
                                <div id="chart-data-list" class="flex flex-col gap-2">
                                    <!-- Populated via JS for interactivity, but we render initial state here if possible or just use a container -->
                                </div>
                                <button id="btn-add-data" class="text-xs text-blue-600 font-medium hover:text-blue-700 text-left flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    Add Item
                                </button>
                                <textarea data-key="${key}" class="hidden prop-input-data-json">${val}</textarea>
                            </div>
                            `
                                          : key === "showLabels"
                                            ? `
                            <div class="flex items-center gap-2">
                                <input type="checkbox" data-key="${key}" ${val ? "checked" : ""} class="prop-input w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-xs text-gray-500">Show Labels</span>
                            </div>
                            `
                                            : key === "code"
                                              ? `
                            <textarea data-key="${key}" rows="10" class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all font-mono resize-y whitespace-pre overflow-x-auto">${val}</textarea>
                            `
                                              : key === "borderRadius"
                                                ? `
                            <div class="flex items-center gap-2 w-full">
                                <input type="range" 
                                    min="0" max="100" step="1"
                                    data-key="${key}" 
                                    value="${val}" 
                                    class="prop-input-range flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                <input type="number" 
                                    data-key="${key}" 
                                    value="${val}" 
                                    class="prop-input w-12 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-1 py-1 text-center outline-none transition-all font-medium">
                            </div>
                            `
                                                : key === "fontFamily"
                                                  ? `
                            <select data-key="${key}" class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all font-medium cursor-pointer appearance-none" style="font-family: '${val}'">
                                <option value="Poppins" style="font-family: 'Poppins'">Poppins</option>
                                <option value="Inter" style="font-family: 'Inter'">Inter</option>
                                <option value="Lobster" style="font-family: 'Lobster'">Lobster</option>
                                <option value="Roboto Mono" style="font-family: 'Roboto Mono'">Roboto Mono</option>
                                <option value="Pacifico" style="font-family: 'Pacifico'">Pacifico</option>
                                <option value="Playfair Display" style="font-family: 'Playfair Display'">Playfair Display</option>
                                <option value="Bangers" style="font-family: 'Bangers'">Bangers</option>
                                <option value="Oswald" style="font-family: 'Oswald'">Oswald</option>
                                <option value="Merriweather" style="font-family: 'Merriweather'">Merriweather</option>
                                <option value="Montserrat" style="font-family: 'Montserrat'">Montserrat</option>
                            </select>
                            `
                                                  : key === "fontWeight"
                                                    ? `
                            <select data-key="${key}" class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all font-medium cursor-pointer appearance-none">
                                <option value="100" ${val === "100" ? "selected" : ""}>Thin 100</option>
                                <option value="300" ${val === "300" ? "selected" : ""}>Light 300</option>
                                <option value="400" ${val === "400" ? "selected" : ""}>Regular 400</option>
                                <option value="500" ${val === "500" ? "selected" : ""}>Medium 500</option>
                                <option value="700" ${val === "700" ? "selected" : ""}>Bold 700</option>
                                <option value="900" ${val === "900" ? "selected" : ""}>Black 900</option>
                            </select>
                            `
                                                    : key.includes("Blur") ||
                                                        key.includes(
                                                            "Offset",
                                                        ) ||
                                                        key.includes("Spacing")
                                                      ? `
                            <div class="flex items-center gap-2 w-full">
                                <input type="range" 
                                    min="-50" max="50" step="1"
                                    data-key="${key}" 
                                    value="${val}" 
                                    class="prop-input-range flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                <input type="number" 
                                    data-key="${key}" 
                                    value="${val}" 
                                    class="prop-input w-12 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-1 py-1 text-center outline-none transition-all font-medium">
                            </div>
                            `
                                                      : `
                            <input type="${isNum ? "number" : "text"}" 
                                   data-key="${key}" 
                                   value="${val}" 
                                   class="prop-input w-full bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs rounded-lg border-0 ring-1 ring-transparent hover:ring-gray-200 dark:hover:ring-gray-700 focus:bg-white dark:focus:bg-gray-900 focus:ring-2 focus:ring-blue-500 px-3 py-2 outline-none transition-all placeholder-gray-400 font-medium">
                            `
                        }
                    </div>
                </div>
            `;
        }

        html += `
             <div class="pt-6 mt-4 border-t border-gray-200 dark:border-gray-800">
                 <button class="delete-obj-btn w-full py-2 bg-red-50 hover:bg-red-100 text-red-600 text-xs font-medium rounded-lg transition-colors flex items-center justify-center gap-2" id="btn-delete-prop">
                    <span>Delete Object</span>
                 </button>
             </div>
        </div>`;

        panel.innerHTML = html;

        // Remove old delete button logic entirely as we use shortcut now

        // Bind Inputs
        panel
            .querySelectorAll(".prop-input, .prop-color, .prop-input-range")
            .forEach((input) => {
                input.addEventListener("input", (e) => {
                    const target = e.target as HTMLInputElement;
                    const key = target.dataset.key!;
                    let val: string | boolean = target.value;

                    if (target.type === "checkbox") {
                        val = target.checked;
                    }

                    // Sync siblings if it is a color picker
                    if (target.classList.contains("prop-color")) {
                        const textInput = panel.querySelector(
                            `.prop-input[data-key="${key}"]`,
                        ) as HTMLInputElement;
                        // No text input sibling for color anymore in some cases, but if exists
                        // Check if there is a sibling span or input to update?
                        // In my new template, I added a span to show value, need to update it?
                        // "text-xs font-mono text-gray-500 dark:text-gray-400 uppercase"
                        const labelSpan =
                            target.parentElement?.nextElementSibling?.querySelector(
                                "span",
                            );
                        if (labelSpan) labelSpan.textContent = String(val);
                    }

                    // Sync Range <-> Number
                    if (target.type === "range") {
                        const numInput = panel.querySelector(
                            `.prop-input[data-key="${key}"][type="number"]`,
                        ) as HTMLInputElement;
                        if (numInput) numInput.value = String(val);
                    }
                    if (target.type === "number") {
                        const rangeInput = panel.querySelector(
                            `.prop-input-range[data-key="${key}"]`,
                        ) as HTMLInputElement;
                        if (rangeInput) rangeInput.value = String(val);
                    }

                    obj.updateProperties({ [key]: val });
                    (window as any).studioEngine.draw(
                        (window as any).studioEngine.currentTime,
                    );
                });
            });

        // Bind delete
        const delBtn = panel.querySelector("#btn-delete-prop");
        if (delBtn) {
            delBtn.addEventListener("click", () => {
                (window as any).studioEngine.removeObject(obj.id);
            });
        }

        // --- Chart Data Editor Logic ---
        const dataListContainer = panel.querySelector("#chart-data-list");
        const hiddenJsonInput = panel.querySelector(
            ".prop-input-data-json",
        ) as HTMLTextAreaElement;
        const btnAddData = panel.querySelector("#btn-add-data");

        if (dataListContainer && hiddenJsonInput && btnAddData) {
            let data: any[] = [];
            try {
                data = JSON.parse(hiddenJsonInput.value);
            } catch (e) {
                data = [];
            }

            const renderList = () => {
                dataListContainer.innerHTML = "";
                data.forEach((item, index) => {
                    const row = document.createElement("div");
                    row.className = "flex items-center gap-2 group/row";

                    // Color Picker
                    row.innerHTML = `
                        <div class="relative w-6 h-6 rounded overflow-hidden ring-1 ring-gray-200 dark:ring-gray-700 shrink-0">
                            <input type="color" 
                                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 border-0 cursor-pointer data-color-input" 
                                value="${item.color || "#3b82f6"}" 
                                data-index="${index}"
                            >
                        </div>
                        <input type="text" 
                            class="flex-1 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 text-xs text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none data-label-input" 
                            value="${item.label}" 
                            data-index="${index}"
                            placeholder="Label"
                        >
                        <input type="number" 
                            class="w-16 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded px-2 py-1 text-xs text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none data-value-input" 
                            value="${item.value}" 
                            data-index="${index}"
                            placeholder="Val"
                        >
                        <button class="text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover/row:opacity-100 transition-opacity data-delete-btn" data-index="${index}">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    dataListContainer.appendChild(row);
                });

                // Re-bind listeners
                bindListListeners();
            };

            const updateData = () => {
                const json = JSON.stringify(data);
                hiddenJsonInput.value = json;
                obj.updateProperties({ data: json });
                (window as any).studioEngine.draw(
                    (window as any).studioEngine.currentTime,
                );
            };

            const bindListListeners = () => {
                // Color Inputs
                dataListContainer
                    .querySelectorAll(".data-color-input")
                    .forEach((input: any) => {
                        input.addEventListener("input", (e: any) => {
                            const idx = parseInt(e.target.dataset.index);
                            data[idx].color = e.target.value;
                            updateData();
                        });
                    });

                // Label Inputs
                dataListContainer
                    .querySelectorAll(".data-label-input")
                    .forEach((input: any) => {
                        input.addEventListener("input", (e: any) => {
                            const idx = parseInt(e.target.dataset.index);
                            data[idx].label = e.target.value;
                            updateData();
                        });
                    });

                // Value Inputs
                dataListContainer
                    .querySelectorAll(".data-value-input")
                    .forEach((input: any) => {
                        input.addEventListener("input", (e: any) => {
                            const idx = parseInt(e.target.dataset.index);
                            data[idx].value = parseFloat(e.target.value) || 0;
                            updateData();
                        });
                    });

                // Delete Buttons
                dataListContainer
                    .querySelectorAll(".data-delete-btn")
                    .forEach((btn: any) => {
                        btn.addEventListener("click", (e: any) => {
                            const idx = parseInt(e.currentTarget.dataset.index);
                            data.splice(idx, 1);
                            renderList();
                            updateData();
                        });
                    });
            };

            btnAddData.addEventListener("click", () => {
                data.push({ label: "New", value: 10, color: "#9ca3af" });
                renderList();
                updateData();
            });

            // Initial Render
            renderList();
        }
    }
</script>
